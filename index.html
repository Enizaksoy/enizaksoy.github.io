<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPU AI Cluster Lab - Configuration Documentation</title>
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --bg-code: #0f0f23;
            --accent-blue: #4fc3f7;
            --accent-green: #66bb6a;
            --accent-orange: #ff9800;
            --accent-red: #ef5350;
            --accent-purple: #ce93d8;
            --text-primary: #e0e0e0;
            --text-secondary: #9e9e9e;
            --border: #2a2a4a;
            --sidebar-width: 280px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.7;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ── Sidebar ── */
        .sidebar {
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            background: #12122a;
            border-right: 1px solid var(--border);
            height: 100vh;
            overflow-y: auto;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 20px 18px 10px;
            border-bottom: 1px solid var(--border);
        }
        .sidebar-header h1 {
            font-size: 1.25em;
            color: var(--accent-blue);
            margin-bottom: 4px;
        }
        .sidebar-header .subtitle {
            font-size: 0.72em;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        .sidebar-nav {
            flex: 1;
            padding: 12px 0;
            overflow-y: auto;
        }
        .sidebar-nav a {
            display: block;
            color: var(--text-secondary);
            text-decoration: none;
            padding: 6px 18px;
            font-size: 0.85em;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .sidebar-nav a:hover {
            color: var(--text-primary);
            background: rgba(79,195,247,0.05);
        }
        .sidebar-nav a.active {
            color: var(--accent-blue);
            border-left-color: var(--accent-blue);
            background: rgba(79,195,247,0.08);
            font-weight: 600;
        }
        .sidebar-nav a.indent {
            padding-left: 36px;
            font-size: 0.8em;
        }
        .sidebar-nav .sub-items {
            display: none;
            overflow: hidden;
        }
        .sidebar-nav .sub-items.expanded {
            display: block;
        }
        .sidebar-nav .nav-section-label {
            font-size: 0.65em;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #555;
            padding: 14px 18px 4px;
            font-weight: bold;
        }

        /* ── Content Panel ── */
        .content-area {
            margin-left: var(--sidebar-width);
            flex: 1;
            height: 100vh;
            overflow-y: auto;
            padding: 30px 40px 60px;
        }
        .section-panel {
            display: none;
            animation: fadeIn 0.25s ease;
        }
        .section-panel.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ── Hamburger for mobile ── */
        .hamburger {
            display: none;
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 200;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--accent-blue);
            font-size: 1.5em;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
        }

        /* ── Original CSS classes preserved ── */
        h1 {
            font-size: 2.2em;
            color: var(--accent-blue);
            margin-bottom: 5px;
        }
        .subtitle {
            color: var(--text-secondary);
            font-size: 1em;
            margin-bottom: 30px;
        }
        h2 {
            font-size: 1.5em;
            color: var(--accent-orange);
            border-bottom: 2px solid var(--accent-orange);
            padding-bottom: 8px;
            margin: 0 0 18px 0;
        }
        h3 {
            font-size: 1.15em;
            color: var(--accent-green);
            margin: 20px 0 10px 0;
        }
        h4 {
            font-size: 1em;
            color: var(--accent-purple);
            margin: 15px 0 8px 0;
        }
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px 25px;
            margin: 15px 0;
        }
        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
            text-transform: uppercase;
        }
        .badge-spine { background: #1565c0; color: white; }
        .badge-leaf { background: #2e7d32; color: white; }
        .badge-server { background: #6a1b9a; color: white; }
        .badge-rail0 { background: #388e3c; color: white; }
        .badge-rail1 { background: #1976d2; color: white; }
        .badge-done { background: #2e7d32; color: white; }
        .badge-fix { background: #d32f2f; color: white; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            font-size: 0.92em;
        }
        th {
            background: #1a237e;
            color: var(--accent-blue);
            padding: 10px 14px;
            text-align: left;
            border: 1px solid var(--border);
        }
        td {
            padding: 8px 14px;
            border: 1px solid var(--border);
        }
        tr:nth-child(even) { background: rgba(255,255,255,0.03); }
        tr:hover { background: rgba(79,195,247,0.07); }

        pre {
            background: var(--bg-code);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 14px 18px;
            overflow-x: auto;
            font-family: 'Cascadia Code', 'Consolas', 'Courier New', monospace;
            font-size: 0.88em;
            line-height: 1.5;
            margin: 10px 0;
        }
        code {
            font-family: 'Cascadia Code', 'Consolas', monospace;
            background: rgba(79,195,247,0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .cmd { color: #81d4fa; }
        .comment { color: #616161; font-style: italic; }
        .highlight { color: #ffcc80; }
        .ip { color: #a5d6a7; }
        .warning { color: var(--accent-red); }

        .topology-ascii {
            background: var(--bg-code);
            border: 2px solid var(--accent-orange);
            border-radius: 8px;
            padding: 20px;
            font-family: 'Cascadia Code', 'Consolas', monospace;
            font-size: 0.82em;
            line-height: 1.4;
            overflow-x: auto;
            white-space: pre;
            color: var(--text-primary);
        }

        /* ── Visual Topology Styles ── */
        .topo-wrap {
            background: var(--bg-code);
            border: 2px solid var(--accent-orange);
            border-radius: 10px;
            padding: 30px 20px 25px;
            position: relative;
            overflow-x: auto;
        }
        .topo-layer {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 60px;
            position: relative;
            margin-bottom: 10px;
        }
        .topo-layer-label {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 10px;
            font-weight: bold;
            color: #555;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        .topo-box {
            border-radius: 8px;
            padding: 10px 14px;
            text-align: center;
            font-size: 11px;
            line-height: 1.6;
            min-width: 200px;
            position: relative;
        }
        .topo-box.spine {
            background: linear-gradient(135deg, #1a237e, #283593);
            border: 2px solid #5c6bc0;
        }
        .topo-box.leaf {
            background: linear-gradient(135deg, #1b3a2d, #2e5040);
            border: 2px solid #4caf50;
        }
        .topo-box.leaf.rail0 { border-color: #66bb6a; }
        .topo-box.leaf.rail1 { border-color: #42a5f5; }
        .topo-box.server {
            background: linear-gradient(135deg, #1a1a35, #2a2a50);
            border: 2px solid #7e57c2;
        }
        .topo-box.mgmt {
            background: linear-gradient(135deg, #263238, #37474f);
            border: 1px dashed #78909c;
            min-width: 160px;
        }
        .topo-box.esxi {
            background: linear-gradient(135deg, #1a1a35, #2a2a50);
            border: 2px solid #ce93d8;
            min-width: 150px;
        }
        .topo-name { font-size: 14px; font-weight: bold; color: #fff; }
        .topo-detail { font-size: 10px; color: #90a4ae; }
        .topo-as { font-size: 10px; color: #ffcc80; font-weight: bold; }
        .topo-ip { font-size: 10px; color: #a5d6a7; }
        .topo-vlan { font-size: 10px; font-weight: bold; }
        .topo-mgmt-ip { font-size: 10px; color: #90caf9; }
        .topo-nic-r0 { font-size: 10px; color: #66bb6a; }
        .topo-nic-r1 { font-size: 10px; color: #42a5f5; }

        .topo-links {
            display: flex;
            justify-content: center;
            padding: 0 40px;
            position: relative;
            height: 80px;
        }
        .topo-links-inner {
            position: relative;
            width: 700px;
            height: 100%;
        }
        .topo-link-label {
            position: absolute;
            font-size: 9px;
            font-family: 'Cascadia Code', 'Consolas', monospace;
            white-space: nowrap;
        }
        .topo-link-label.orange { color: #ff9800; }
        .topo-link-label.green { color: #66bb6a; }
        .topo-link-label.blue { color: #42a5f5; }
        .topo-link-label.purple { color: #ce93d8; }
        .topo-link-label.grey { color: #78909c; }

        .topo-svg {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .topo-fabric-banner {
            text-align: center;
            padding: 6px 0;
            font-size: 10px;
            color: #ff9800;
            font-weight: bold;
            letter-spacing: 1px;
        }
        .topo-link-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            font-family: 'Cascadia Code', 'Consolas', monospace;
            margin: 6px 0;
        }
        .topo-link-table td {
            padding: 3px 8px;
            border: none;
            color: #b0bec5;
        }
        .topo-link-table .arrow { color: #ff9800; text-align: center; width: 30px; }
        .topo-link-table .port { color: #ffcc80; }
        .topo-link-table .ip { color: #a5d6a7; }
        .topo-server-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            font-size: 10px;
            font-family: 'Cascadia Code', 'Consolas', monospace;
            padding: 4px 0;
        }
        .topo-server-links .link-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .topo-server-links .link-item.r0 { color: #66bb6a; }
        .topo-server-links .link-item.r1 { color: #42a5f5; }
        .topo-server-links .link-item.esxi-link { color: #ce93d8; }
        .topo-divider {
            border: none;
            border-top: 1px dashed #333;
            margin: 8px 0;
        }

        .timeline {
            border-left: 3px solid var(--accent-blue);
            padding-left: 25px;
            margin: 15px 0 15px 15px;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 18px;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -33px;
            top: 6px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-blue);
            border: 2px solid var(--bg-dark);
        }
        .timeline-item.fix::before { background: var(--accent-red); }
        .timeline-item .step-title {
            font-weight: bold;
            color: var(--accent-green);
        }
        .timeline-item.fix .step-title { color: var(--accent-red); }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        @media (max-width: 800px) { .grid-2 { grid-template-columns: 1fr; } }

        .toc {
            background: var(--bg-card);
            border: 1px solid var(--accent-blue);
            border-radius: 10px;
            padding: 20px 25px;
            margin: 20px 0;
        }
        .toc a {
            color: var(--accent-blue);
            text-decoration: none;
            display: block;
            padding: 3px 0;
        }
        .toc a:hover { text-decoration: underline; color: #81d4fa; }
        .toc .indent { margin-left: 20px; }

        .status-ok { color: var(--accent-green); font-weight: bold; }
        .status-fail { color: var(--accent-red); font-weight: bold; }

        hr { border: none; border-top: 1px solid var(--border); margin: 30px 0; }

        .footer {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85em;
            margin-top: 40px;
            padding: 20px;
            border-top: 1px solid var(--border);
        }

        /* ── Responsive ── */
        @media (max-width: 900px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .hamburger {
                display: block;
            }
            .content-area {
                margin-left: 0;
                padding: 20px 16px 60px;
                padding-top: 50px;
            }
        }

        /* scrollbar styling */
        .sidebar::-webkit-scrollbar,
        .content-area::-webkit-scrollbar {
            width: 6px;
        }
        .sidebar::-webkit-scrollbar-track,
        .content-area::-webkit-scrollbar-track {
            background: transparent;
        }
        .sidebar::-webkit-scrollbar-thumb {
            background: #2a2a4a;
            border-radius: 3px;
        }
        .content-area::-webkit-scrollbar-thumb {
            background: #3a3a5a;
            border-radius: 3px;
        }
    </style>
</head>
<body>

<!-- Hamburger for mobile -->
<button class="hamburger" onclick="toggleSidebar()">&#9776;</button>

<!-- ── LEFT SIDEBAR ── -->
<nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h1>GPU AI Cluster Lab</h1>
        <div class="subtitle">Cisco Nexus 9332PQ Spine-Leaf Fabric<br>eBGP L3 Rail Routing | RDMA Network<br>February 2026</div>
    </div>
    <div class="sidebar-nav" id="sidebar-nav">
        <div class="nav-section-label">Documentation</div>
        <a onclick="showSection('overview')" data-section="overview">1. Network Overview</a>
        <a onclick="showSection('topology')" data-section="topology">2. Physical Topology</a>
        <a onclick="showSection('inventory')" data-section="inventory">3. Device Inventory &amp; IP Addressing</a>
        <a onclick="showSection('fabric-links')" data-section="fabric-links">4. Fabric Link Addressing</a>
        <a onclick="showSection('ebgp')" data-section="ebgp">5. eBGP Underlay Configuration</a>
        <div class="sub-items" data-parent="ebgp">
            <a class="indent" onclick="showSection('ebgp')" data-section="ebgp" data-scroll="ebgp-spine1">5.1 Spine1 BGP Config</a>
            <a class="indent" onclick="showSection('ebgp')" data-section="ebgp" data-scroll="ebgp-spine2">5.2 Spine2 BGP Config</a>
            <a class="indent" onclick="showSection('ebgp')" data-section="ebgp" data-scroll="ebgp-leaf1">5.3 Leaf1 BGP Config</a>
            <a class="indent" onclick="showSection('ebgp')" data-section="ebgp" data-scroll="ebgp-leaf2">5.4 Leaf2 BGP Config</a>
        </div>
        <a onclick="showSection('qos-config')" data-section="qos-config">6. QoS / PFC / ECN Configuration</a>
        <div class="sub-items" data-parent="qos-config">
            <a class="indent" onclick="showSection('qos-config')" data-section="qos-config" data-scroll="qos-classification">6.1 Classification &amp; Marking</a>
            <a class="indent" onclick="showSection('qos-config')" data-section="qos-config" data-scroll="qos-network">6.2 Network QoS (PFC + MTU)</a>
            <a class="indent" onclick="showSection('qos-config')" data-section="qos-config" data-scroll="qos-queuing">6.3 Egress Queuing (ECN)</a>
            <a class="indent" onclick="showSection('qos-config')" data-section="qos-config" data-scroll="qos-summary">6.4 Design Summary</a>
        </div>
        <a onclick="showSection('rail-design')" data-section="rail-design">7. RDMA Rail Design</a>
        <div class="sub-items" data-parent="rail-design">
            <a class="indent" onclick="showSection('rail-design')" data-section="rail-design" data-scroll="rail0">7.1 Rail 0 &mdash; Leaf1 / VLAN 100</a>
            <a class="indent" onclick="showSection('rail-design')" data-section="rail-design" data-scroll="rail1">7.2 Rail 1 &mdash; Leaf2 / VLAN 101</a>
        </div>
        <a onclick="showSection('server-config')" data-section="server-config">8. GPU Server Configuration</a>
        <div class="sub-items" data-parent="server-config">
            <a class="indent" onclick="showSection('server-config')" data-section="server-config" data-scroll="server-ips">8.1 NIC IP Addressing</a>
            <a class="indent" onclick="showSection('server-config')" data-section="server-config" data-scroll="server-routing">8.2 Per-NIC Policy Routing</a>
            <a class="indent" onclick="showSection('server-config')" data-section="server-config" data-scroll="server-netplan">8.3 Netplan Persistence</a>
        </div>
        <a onclick="showSection('mtu')" data-section="mtu">9. MTU Configuration</a>
        <a onclick="showSection('changes')" data-section="changes">10. Change Log &amp; Issues Resolved</a>
        <a onclick="showSection('scripts')" data-section="scripts">11. Automation Scripts</a>
        <a onclick="showSection('verification')" data-section="verification">12. Verification Results</a>
        <a onclick="showSection('rdma-perf')" data-section="rdma-perf">13. RDMA Performance Results</a>
        <div class="sub-items" data-parent="rdma-perf">
            <a class="indent" onclick="showSection('rdma-perf')" data-section="rdma-perf" data-scroll="rdma-bw">13.1 Bandwidth Tests</a>
            <a class="indent" onclick="showSection('rdma-perf')" data-section="rdma-perf" data-scroll="rdma-lat">13.2 Latency Tests</a>
            <a class="indent" onclick="showSection('rdma-perf')" data-section="rdma-perf" data-scroll="rdma-context">13.3 How Our Lab Compares</a>
        </div>
    </div>
</nav>

<!-- ── RIGHT CONTENT AREA ── -->
<main class="content-area" id="content-area">

    <!-- ============================================================ -->
    <!-- 1. OVERVIEW -->
    <!-- ============================================================ -->
    <div class="section-panel" id="panel-overview">
        <h2 id="overview">1. Network Overview</h2>
        <div class="card">
            <p>This lab implements an <strong>AI/GPU cluster network</strong> using a Cisco Nexus 9332PQ spine-leaf fabric
            with a <strong>rail-based L3 routing design</strong> optimized for RDMA traffic between GPU servers.</p>

            <h4>Key Design Decisions</h4>
            <ul style="margin: 10px 0 0 20px;">
                <li><strong>eBGP underlay</strong> (no OSPF, no EVPN/VXLAN) &mdash; each switch has its own AS number</li>
                <li><strong>Rail design</strong> &mdash; each leaf = one rail, each NIC on a server maps to exactly one leaf/rail</li>
                <li><strong>No LACP</strong> &mdash; rails provide parallelism without hashing latency</li>
                <li><strong>Per-NIC policy routing</strong> on servers &mdash; source-based routing tables for deterministic paths</li>
                <li><strong>Cross-rail traffic</strong> routed through spines via eBGP (ECMP with 2 paths)</li>
                <li><strong>Jumbo MTU</strong> &mdash; 9216 on fabric, 9000 on servers</li>
                <li><strong>BFD</strong> enabled on all eBGP peerings for fast failure detection</li>
            </ul>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- 2. TOPOLOGY -->
    <!-- ============================================================ -->
    <div class="section-panel" id="panel-topology">
        <h2 id="topology">2. Physical Topology</h2>
        <div class="topo-wrap">

            <!-- MANAGEMENT LAYER -->
            <div class="topo-layer" style="margin-bottom:5px;">
                <div class="topo-box mgmt">
                    <div class="topo-name" style="font-size:12px;">Lab_3750X</div>
                    <div class="topo-detail">Management Switch</div>
                    <div class="topo-mgmt-ip">192.168.51.142</div>
                </div>
            </div>

            <div style="text-align:center; color:#78909c; font-size:9px; padding:2px 0 8px; font-family:monospace;">
                &#9474; mgmt &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mgmt &#9474;
            </div>

            <!-- SPINE LAYER -->
            <div style="text-align:center; color:#555; font-size:10px; font-weight:bold; letter-spacing:2px; margin-bottom:6px;">SPINE LAYER</div>
            <div class="topo-layer">
                <div class="topo-box spine">
                    <div class="topo-name">NX_AI_Spine1</div>
                    <div class="topo-detail">Nexus 9332PQ &middot; NX-OS 9.3(13)</div>
                    <div class="topo-as">BGP AS 65000</div>
                    <div class="topo-ip">Lo0: 10.2.0.1</div>
                    <div class="topo-mgmt-ip">Mgmt: 192.168.51.232</div>
                </div>
                <div class="topo-box spine">
                    <div class="topo-name">NX_AI_Spine2</div>
                    <div class="topo-detail">Nexus 9332PQ &middot; NX-OS 9.3(13)</div>
                    <div class="topo-as">BGP AS 65000</div>
                    <div class="topo-ip">Lo0: 10.2.0.2</div>
                    <div class="topo-mgmt-ip">Mgmt: 192.168.51.231</div>
                </div>
            </div>

            <!-- FABRIC LINKS TABLE -->
            <div class="topo-fabric-banner">&#9552;&#9552;&#9552; 40G eBGP + BFD FABRIC &#9552;&#9552;&#9552;</div>
            <table class="topo-link-table" style="max-width:680px; margin:4px auto;">
                <tr>
                    <td class="port" style="text-align:right;">Spine1 Eth1/14</td>
                    <td class="ip" style="text-align:right;">10.4.0.6</td>
                    <td class="arrow">&#8644;</td>
                    <td class="ip">10.4.0.5</td>
                    <td class="port">Eth1/14 Leaf1</td>
                </tr>
                <tr>
                    <td class="port" style="text-align:right;">Spine1 Eth1/18</td>
                    <td class="ip" style="text-align:right;">10.4.0.13</td>
                    <td class="arrow">&#8644;</td>
                    <td class="ip">10.4.0.14</td>
                    <td class="port">Eth1/18 Leaf2</td>
                </tr>
                <tr>
                    <td class="port" style="text-align:right;">Spine2 Eth1/13</td>
                    <td class="ip" style="text-align:right;">10.4.0.2</td>
                    <td class="arrow">&#8644;</td>
                    <td class="ip">10.4.0.1</td>
                    <td class="port">Eth1/13 Leaf1</td>
                </tr>
                <tr>
                    <td class="port" style="text-align:right;">Spine2 Eth1/17</td>
                    <td class="ip" style="text-align:right;">10.4.0.10</td>
                    <td class="arrow">&#8644;</td>
                    <td class="ip">10.4.0.9</td>
                    <td class="port">Eth1/17 Leaf2</td>
                </tr>
            </table>

            <!-- LEAF LAYER -->
            <div style="text-align:center; color:#555; font-size:10px; font-weight:bold; letter-spacing:2px; margin:10px 0 6px;">LEAF LAYER</div>
            <div class="topo-layer">
                <div class="topo-box leaf rail0">
                    <div class="topo-name">NX_AI_Leaf1</div>
                    <div class="topo-detail">Nexus 9332PQ &middot; NX-OS 9.3(13)</div>
                    <div class="topo-as">BGP AS 65001</div>
                    <div class="topo-ip">Lo0: 10.2.0.3</div>
                    <div class="topo-vlan" style="color:#66bb6a;">&#9632; VLAN 100 &mdash; Rail 0</div>
                    <div class="topo-ip">SVI: 10.0.0.254/24</div>
                    <div class="topo-mgmt-ip">Mgmt: 192.168.50.229</div>
                </div>
                <div class="topo-box leaf rail1">
                    <div class="topo-name">NX_AI_Leaf2</div>
                    <div class="topo-detail">Nexus 9332PQ &middot; NX-OS 9.3(13)</div>
                    <div class="topo-as">BGP AS 65002</div>
                    <div class="topo-ip">Lo0: 10.2.0.4</div>
                    <div class="topo-vlan" style="color:#42a5f5;">&#9632; VLAN 101 &mdash; Rail 1</div>
                    <div class="topo-ip">SVI: 10.0.1.254/24</div>
                    <div class="topo-mgmt-ip">Mgmt: 192.168.51.230</div>
                </div>
            </div>

            <!-- SERVER-FACING LINKS -->
            <div style="padding:8px 0 4px;">
                <div class="topo-server-links">
                    <div class="link-item r0">&#9632; Leaf1 Eth1/27 &rarr; gpu1 ens6d1</div>
                    <div class="link-item r1">&#9632; Leaf2 Eth1/27 &rarr; gpu1 ens6</div>
                    <div class="link-item r0">&#9632; Leaf1 Eth1/28 &rarr; gpu2 ens6d1</div>
                    <div class="link-item r1">&#9632; Leaf2 Eth1/28 &rarr; gpu2 ens6</div>
                    <div class="link-item esxi-link">&#9632; Leaf2 Eth1/1/1 &rarr; ESXi vmnic5</div>
                </div>
            </div>

            <!-- COMPUTE LAYER -->
            <div style="text-align:center; color:#555; font-size:10px; font-weight:bold; letter-spacing:2px; margin:8px 0 6px;">COMPUTE LAYER</div>
            <div class="topo-layer" style="gap:30px;">
                <div class="topo-box server">
                    <div class="topo-name">gpuserver1</div>
                    <div class="topo-detail">Ubuntu &middot; Mellanox ConnectX-3 Pro</div>
                    <div class="topo-mgmt-ip">Mgmt: 192.168.51.73</div>
                    <hr class="topo-divider">
                    <div class="topo-nic-r0">&#9632; ens6d1: 10.0.0.1/24 &rarr; tbl 100 gw 10.0.0.254</div>
                    <div class="topo-nic-r1">&#9632; ens6: &nbsp; 10.0.1.1/24 &rarr; tbl 101 gw 10.0.1.254</div>
                </div>
                <div class="topo-box server">
                    <div class="topo-name">gpuserver2</div>
                    <div class="topo-detail">Ubuntu &middot; Mellanox ConnectX-3 Pro</div>
                    <div class="topo-mgmt-ip">Mgmt: 192.168.51.71</div>
                    <hr class="topo-divider">
                    <div class="topo-nic-r0">&#9632; ens6d1: 10.0.0.2/24 &rarr; tbl 100 gw 10.0.0.254</div>
                    <div class="topo-nic-r1">&#9632; ens6: &nbsp; 10.0.1.2/24 &rarr; tbl 101 gw 10.0.1.254</div>
                </div>
                <div class="topo-box esxi">
                    <div class="topo-name" style="font-size:13px;">ESXi Host</div>
                    <div class="topo-detail">VMware ESXi 7.0</div>
                    <div class="topo-mgmt-ip">192.168.50.32</div>
                    <div class="topo-detail" style="color:#ce93d8;">vmnic5 (10G)</div>
                </div>
            </div>

            <!-- TRAFFIC FLOW KEY -->
            <div style="margin-top:15px; padding:10px 15px; background:rgba(255,255,255,0.03); border-radius:6px; border:1px solid #2a2a4a;">
                <div style="font-size:10px; color:#999; font-weight:bold; margin-bottom:6px;">TRAFFIC FLOW</div>
                <div style="display:flex; gap:25px; flex-wrap:wrap; font-size:10px;">
                    <div><span style="color:#66bb6a;">&#9632; Rail 0 (same-rail):</span> <span style="color:#b0bec5;">gpu &rarr; ens6d1 &rarr; Leaf1 &rarr; ens6d1 &rarr; gpu</span></div>
                    <div><span style="color:#42a5f5;">&#9632; Rail 1 (same-rail):</span> <span style="color:#b0bec5;">gpu &rarr; ens6 &rarr; Leaf2 &rarr; ens6 &rarr; gpu</span></div>
                    <div><span style="color:#ff9800;">&#9632; Cross-rail:</span> <span style="color:#b0bec5;">gpu &rarr; Leaf1 &rarr; Spine &rarr; Leaf2 &rarr; gpu (ECMP x2)</span></div>
                </div>
            </div>

        </div>
    </div>

    <!-- ============================================================ -->
    <!-- 3. DEVICE INVENTORY -->
    <!-- ============================================================ -->
    <div class="section-panel" id="panel-inventory">
        <h2 id="inventory">3. Device Inventory &amp; IP Addressing</h2>

        <h3>Network Switches</h3>
        <table>
            <tr>
                <th>Device</th>
                <th>Role</th>
                <th>Platform</th>
                <th>NX-OS</th>
                <th>Mgmt IP</th>
                <th>Loopback0</th>
                <th>BGP AS</th>
            </tr>
            <tr>
                <td><strong>NX_AI_Spine1</strong></td>
                <td><span class="badge badge-spine">Spine</span></td>
                <td>Nexus 9332PQ</td>
                <td>9.3(13)</td>
                <td><code>192.168.51.232</code></td>
                <td><code>10.2.0.1/32</code></td>
                <td><code>65000</code></td>
            </tr>
            <tr>
                <td><strong>NX_AI_Spine2</strong></td>
                <td><span class="badge badge-spine">Spine</span></td>
                <td>Nexus 9332PQ</td>
                <td>9.3(13)</td>
                <td><code>192.168.51.231</code></td>
                <td><code>10.2.0.2/32</code></td>
                <td><code>65000</code></td>
            </tr>
            <tr>
                <td><strong>NX_AI_Leaf1</strong></td>
                <td><span class="badge badge-leaf">Leaf</span> <span class="badge badge-rail0">Rail 0</span></td>
                <td>Nexus 9332PQ</td>
                <td>9.3(13)</td>
                <td><code>192.168.50.229</code></td>
                <td><code>10.2.0.3/32</code></td>
                <td><code>65001</code></td>
            </tr>
            <tr>
                <td><strong>NX_AI_Leaf2</strong></td>
                <td><span class="badge badge-leaf">Leaf</span> <span class="badge badge-rail1">Rail 1</span></td>
                <td>Nexus 9332PQ</td>
                <td>9.3(13)</td>
                <td><code>192.168.51.230</code></td>
                <td><code>10.2.0.4/32</code></td>
                <td><code>65002</code></td>
            </tr>
        </table>

        <h3>GPU Servers</h3>
        <table>
            <tr>
                <th>Server</th>
                <th>OS</th>
                <th>NIC</th>
                <th>Mgmt IP</th>
                <th>ens6d1 (Rail 0)</th>
                <th>ens6 (Rail 1)</th>
            </tr>
            <tr>
                <td><strong>gpuserver1</strong></td>
                <td>Ubuntu</td>
                <td>Mellanox ConnectX-3 Pro (Dual-port 40G)</td>
                <td><code>192.168.51.73</code></td>
                <td><code>10.0.0.1/24</code></td>
                <td><code>10.0.1.1/24</code></td>
            </tr>
            <tr>
                <td><strong>gpuserver2</strong></td>
                <td>Ubuntu</td>
                <td>Mellanox ConnectX-3 Pro (Dual-port 40G)</td>
                <td><code>192.168.51.71</code></td>
                <td><code>10.0.0.2/24</code></td>
                <td><code>10.0.1.2/24</code></td>
            </tr>
        </table>

        <h3>Other Devices</h3>
        <table>
            <tr><th>Device</th><th>Role</th><th>IP</th></tr>
            <tr><td><strong>Lab_3750X</strong></td><td>Management Switch</td><td><code>192.168.51.142</code></td></tr>
            <tr><td><strong>ESXi Host</strong></td><td>VMware ESXi 7.0</td><td><code>192.168.50.32</code></td></tr>
        </table>
    </div>

    <!-- ============================================================ -->
    <!-- 4. FABRIC LINKS -->
    <!-- ============================================================ -->
    <div class="section-panel" id="panel-fabric-links">
        <h2 id="fabric-links">4. Fabric Link Addressing</h2>
        <div class="card">
            <p>All fabric links are <strong>40G QSFP+ point-to-point L3</strong> links using /30 subnets.</p>
        </div>
        <table>
            <tr>
                <th>Link</th>
                <th>Side A</th>
                <th>Interface</th>
                <th>IP</th>
                <th>Side B</th>
                <th>Interface</th>
                <th>IP</th>
                <th>Subnet</th>
            </tr>
            <tr>
                <td>1</td>
                <td>Spine1</td><td>Eth1/14</td><td><code>10.4.0.6</code></td>
                <td>Leaf1</td><td>Eth1/14</td><td><code>10.4.0.5</code></td>
                <td><code>10.4.0.4/30</code></td>
            </tr>
            <tr>
                <td>2</td>
                <td>Spine1</td><td>Eth1/18</td><td><code>10.4.0.13</code></td>
                <td>Leaf2</td><td>Eth1/18</td><td><code>10.4.0.14</code></td>
                <td><code>10.4.0.12/30</code></td>
            </tr>
            <tr>
                <td>3</td>
                <td>Spine2</td><td>Eth1/13</td><td><code>10.4.0.2</code></td>
                <td>Leaf1</td><td>Eth1/13</td><td><code>10.4.0.1</code></td>
                <td><code>10.4.0.0/30</code></td>
            </tr>
            <tr>
                <td>4</td>
                <td>Spine2</td><td>Eth1/17</td><td><code>10.4.0.10</code></td>
                <td>Leaf2</td><td>Eth1/17</td><td><code>10.4.0.9</code></td>
                <td><code>10.4.0.8/30</code></td>
            </tr>
        </table>

        <h3>Server-Facing Links</h3>
        <table>
            <tr><th>Switch</th><th>Port</th><th>VLAN</th><th>Connected To</th><th>Server NIC</th><th>Speed</th></tr>
            <tr>
                <td>Leaf1</td><td>Eth1/27</td><td>100 (access)</td>
                <td>gpuserver1</td><td>ens6d1</td><td>40G</td>
            </tr>
            <tr>
                <td>Leaf1</td><td>Eth1/28</td><td>100 (access)</td>
                <td>gpuserver2</td><td>ens6d1</td><td>40G</td>
            </tr>
            <tr>
                <td>Leaf2</td><td>Eth1/27</td><td>101 (access)</td>
                <td>gpuserver1</td><td>ens6</td><td>40G</td>
            </tr>
            <tr>
                <td>Leaf2</td><td>Eth1/28</td><td>101 (access)</td>
                <td>gpuserver2</td><td>ens6</td><td>40G</td>
            </tr>
            <tr>
                <td>Leaf2</td><td>Eth1/1/1</td><td>&mdash;</td>
                <td>ESXi Host</td><td>vmnic5</td><td>10G</td>
            </tr>
        </table>
    </div>

    <!-- ============================================================ -->
    <!-- 5. eBGP CONFIGURATION -->
    <!-- ============================================================ -->
    <div class="section-panel" id="panel-ebgp">
        <h2 id="ebgp">5. eBGP Underlay Configuration</h2>
        <div class="card">
            <p><strong>Design:</strong> eBGP with physical interface peering (no loopback peering, no OSPF).
            Each tier has its own AS number. Leaves have <code>maximum-paths 2</code> for ECMP across both spines.
            BFD is enabled on all BGP sessions for sub-second failover.</p>
            <table>
                <tr><th>Device</th><th>BGP AS</th><th>Router-ID</th><th>Networks Advertised</th></tr>
                <tr><td>Spine1</td><td>65000</td><td>10.2.0.1</td><td><code>10.2.0.1/32</code></td></tr>
                <tr><td>Spine2</td><td>65000</td><td>10.2.0.2</td><td><code>10.2.0.2/32</code></td></tr>
                <tr><td>Leaf1</td><td>65001</td><td>10.2.0.3</td><td><code>10.2.0.3/32</code>, <code>10.3.0.1/32</code>, <code>10.0.0.0/24</code></td></tr>
                <tr><td>Leaf2</td><td>65002</td><td>10.2.0.4</td><td><code>10.2.0.4/32</code>, <code>10.3.0.2/32</code>, <code>10.0.1.0/24</code></td></tr>
            </table>
        </div>

        <!-- SPINE1 BGP -->
        <h3 id="ebgp-spine1">5.1 NX_AI_Spine1 &mdash; BGP Configuration</h3>
        <pre><span class="comment">! NX_AI_Spine1 (192.168.51.232) - AS 65000</span>

<span class="cmd">router bgp 65000</span>
  <span class="cmd">router-id</span> <span class="ip">10.2.0.1</span>
  <span class="cmd">address-family ipv4 unicast</span>
    <span class="cmd">network</span> <span class="ip">10.2.0.1/32</span>

  <span class="comment">! Peer to Leaf1 via Eth1/14</span>
  <span class="cmd">neighbor</span> <span class="ip">10.4.0.5</span>
    <span class="cmd">remote-as</span> <span class="highlight">65001</span>
    <span class="cmd">description</span> to-NX-AI-Leaf1
    <span class="cmd">bfd</span>
    <span class="cmd">address-family ipv4 unicast</span>

  <span class="comment">! Peer to Leaf2 via Eth1/18</span>
  <span class="cmd">neighbor</span> <span class="ip">10.4.0.14</span>
    <span class="cmd">remote-as</span> <span class="highlight">65002</span>
    <span class="cmd">description</span> to-NX-AI-Leaf2
    <span class="cmd">bfd</span>
    <span class="cmd">address-family ipv4 unicast</span></pre>

        <!-- SPINE2 BGP -->
        <h3 id="ebgp-spine2">5.2 NX_AI_Spine2 &mdash; BGP Configuration</h3>
        <pre><span class="comment">! NX_AI_Spine2 (192.168.51.231) - AS 65000</span>

<span class="cmd">router bgp 65000</span>
  <span class="cmd">router-id</span> <span class="ip">10.2.0.2</span>
  <span class="cmd">address-family ipv4 unicast</span>
    <span class="cmd">network</span> <span class="ip">10.2.0.2/32</span>

  <span class="comment">! Peer to Leaf1 via Eth1/13</span>
  <span class="cmd">neighbor</span> <span class="ip">10.4.0.1</span>
    <span class="cmd">remote-as</span> <span class="highlight">65001</span>
    <span class="cmd">description</span> to-NX-AI-Leaf1
    <span class="cmd">bfd</span>
    <span class="cmd">address-family ipv4 unicast</span>

  <span class="comment">! Peer to Leaf2 via Eth1/17</span>
  <span class="cmd">neighbor</span> <span class="ip">10.4.0.9</span>
    <span class="cmd">remote-as</span> <span class="highlight">65002</span>
    <span class="cmd">description</span> to-NX-AI-Leaf2
    <span class="cmd">bfd</span>
    <span class="cmd">address-family ipv4 unicast</span></pre>

        <!-- LEAF1 BGP -->
        <h3 id="ebgp-leaf1">5.3 NX_AI_Leaf1 &mdash; BGP Configuration</h3>
        <pre><span class="comment">! NX_AI_Leaf1 (192.168.50.229) - AS 65001</span>

<span class="cmd">router bgp 65001</span>
  <span class="cmd">router-id</span> <span class="ip">10.2.0.3</span>
  <span class="cmd">address-family ipv4 unicast</span>
    <span class="cmd">network</span> <span class="ip">10.2.0.3/32</span>
    <span class="cmd">network</span> <span class="ip">10.3.0.1/32</span>
    <span class="cmd">network</span> <span class="ip">10.0.0.0/24</span>           <span class="comment">! Rail 0 SVI subnet</span>
    <span class="cmd">maximum-paths</span> <span class="highlight">2</span>              <span class="comment">! ECMP across both spines</span>

  <span class="comment">! Peer to Spine1 via Eth1/14</span>
  <span class="cmd">neighbor</span> <span class="ip">10.4.0.6</span>
    <span class="cmd">remote-as</span> <span class="highlight">65000</span>
    <span class="cmd">description</span> to-NX-AI-Spine1
    <span class="cmd">bfd</span>
    <span class="cmd">address-family ipv4 unicast</span>

  <span class="comment">! Peer to Spine2 via Eth1/13</span>
  <span class="cmd">neighbor</span> <span class="ip">10.4.0.2</span>
    <span class="cmd">remote-as</span> <span class="highlight">65000</span>
    <span class="cmd">description</span> to-NX-AI-Spine2
    <span class="cmd">bfd</span>
    <span class="cmd">address-family ipv4 unicast</span></pre>

        <!-- LEAF2 BGP -->
        <h3 id="ebgp-leaf2">5.4 NX_AI_Leaf2 &mdash; BGP Configuration</h3>
        <pre><span class="comment">! NX_AI_Leaf2 (192.168.51.230) - AS 65002</span>

<span class="cmd">router bgp 65002</span>
  <span class="cmd">router-id</span> <span class="ip">10.2.0.4</span>
  <span class="cmd">address-family ipv4 unicast</span>
    <span class="cmd">network</span> <span class="ip">10.2.0.4/32</span>
    <span class="cmd">network</span> <span class="ip">10.3.0.2/32</span>
    <span class="cmd">network</span> <span class="ip">10.0.1.0/24</span>           <span class="comment">! Rail 1 SVI subnet</span>
    <span class="cmd">maximum-paths</span> <span class="highlight">2</span>              <span class="comment">! ECMP across both spines</span>

  <span class="comment">! Peer to Spine1 via Eth1/18</span>
  <span class="cmd">neighbor</span> <span class="ip">10.4.0.13</span>
    <span class="cmd">remote-as</span> <span class="highlight">65000</span>
    <span class="cmd">description</span> to-NX-AI-Spine1
    <span class="cmd">bfd</span>
    <span class="cmd">address-family ipv4 unicast</span>

  <span class="comment">! Peer to Spine2 via Eth1/17</span>
  <span class="cmd">neighbor</span> <span class="ip">10.4.0.10</span>
    <span class="cmd">remote-as</span> <span class="highlight">65000</span>
    <span class="cmd">description</span> to-NX-AI-Spine2
    <span class="cmd">bfd</span>
    <span class="cmd">address-family ipv4 unicast</span></pre>
    </div>

    <!-- ============================================================ -->
    <!-- 6. QoS / PFC / ECN CONFIGURATION -->
    <!-- ============================================================ -->
    <div class="section-panel" id="panel-qos-config">
        <h2 id="qos-config">6. QoS / PFC / ECN Configuration (Lossless RDMA)</h2>
        <div class="card">
            <p>All 4 switches (Spine1, Spine2, Leaf1, Leaf2) run <strong>identical QoS configuration</strong> for lossless RoCE v2.
            RDMA traffic is classified by DSCP 26 and RoCE UDP ports (4741/4791), mapped to <strong>CoS 3 / qos-group 3</strong>,
            with Priority Flow Control (PFC) preventing packet drops and ECN signaling congestion before queues overflow.</p>
            <p style="margin-top:8px; color:var(--text-secondary);">Configuration audited and cleaned up February 2026.
            Unused leftover class-maps (<code>RDM</code>, <code>RDMA_2</code>, <code>RDMA_Class</code>) and
            policy-maps (<code>ROCE_NET_POLICY</code>, <code>testcos</code>) were removed from all switches.</p>
        </div>

        <!-- 6.1 CLASSIFICATION -->
        <h3 id="qos-classification">6.1 Classification &amp; Marking</h3>

        <h4>ACL &mdash; RoCE UDP Port Matching</h4>
        <pre><span class="cmd">ip access-list rdma</span>
  <span class="ip">10</span> permit udp any any eq <span class="highlight">4741</span>
  <span class="ip">20</span> permit udp any eq <span class="highlight">4741</span> any
  <span class="ip">30</span> permit udp any eq <span class="highlight">4791</span> any
  <span class="ip">40</span> permit udp any any eq <span class="highlight">4791</span>
<span class="comment">! UDP 4741 = RoCE v1, UDP 4791 = RoCE v2</span></pre>

        <h4>Class Maps &mdash; RDMA Traffic Identification</h4>
        <pre><span class="comment">! Match DSCP 26 (CS3/AF31 — standard RoCE marking)</span>
<span class="cmd">class-map type qos match-all RDMA</span>
  match dscp <span class="highlight">26</span>

<span class="comment">! Match DSCP 26 OR RoCE UDP ports (broader catch-all)</span>
<span class="cmd">class-map type qos match-any RDMA_UDP</span>
  match dscp <span class="highlight">26</span>
  match access-group name <span class="highlight">rdma</span></pre>

        <h4>Input Marking Policy</h4>
        <pre><span class="comment">! Classify RDMA traffic into qos-group 3 for downstream processing</span>
<span class="cmd">policy-map type qos QOS_MARKING</span>
  class RDMA
    set qos-group <span class="highlight">3</span>
  class RDMA_UDP
    set qos-group <span class="highlight">3</span></pre>

        <div class="card">
            <h4 style="margin-top:0;">Classification Flow</h4>
            <p style="font-family:monospace; font-size:0.95em; line-height:2;">
                Ingress packet &rarr; <span style="color:#4fc3f7;">DSCP 26?</span> or <span style="color:#4fc3f7;">UDP 4741/4791?</span>
                &rarr; <span style="color:#ff9800;">qos-group 3</span>
                &rarr; <span style="color:#66bb6a;">CoS 3 queue</span>
                &rarr; PFC protected + ECN marked
            </p>
        </div>

        <!-- 6.2 NETWORK QOS -->
        <h3 id="qos-network">6.2 Network QoS (PFC + MTU)</h3>

        <pre><span class="comment">! Network QoS: controls MTU per queue and PFC behavior</span>
<span class="cmd">policy-map type network-qos QOS_NETWORK</span>
  class type network-qos <span class="highlight">c-nq3</span>
    mtu <span class="highlight">9216</span>              <span class="comment">&larr; jumbo frames for RDMA queue</span>
    pause pfc-cos <span class="highlight">3</span>       <span class="comment">&larr; IEEE 802.1Qbb PFC on CoS 3</span>
  class type network-qos <span class="highlight">c-nq-default</span>
    mtu <span class="highlight">9216</span>              <span class="comment">&larr; jumbo for all other traffic too</span></pre>

        <h4>Per-Interface PFC Settings</h4>
        <pre><span class="comment">! Applied to ALL server-facing and fabric-facing interfaces:</span>
<span class="cmd">priority-flow-control mode on</span>

<span class="comment">! Global features enabled:</span>
<span class="cmd">feature lldp</span>     <span class="comment">&larr; Link Layer Discovery Protocol</span>
<span class="cmd">feature dcbx</span>     <span class="comment">&larr; Data Center Bridging Capability Exchange</span></pre>

        <div class="card" style="border-color:#ef5350;">
            <h4 style="margin-top:0; color:#ef5350;">How PFC Prevents RDMA Packet Loss</h4>
            <p>When a switch queue for CoS 3 fills to a threshold, PFC sends an IEEE 802.1Qbb <strong>PAUSE frame</strong>
            back to the upstream sender, telling it to stop transmitting on that priority class. This creates a
            <strong>lossless fabric</strong> &mdash; the upstream device buffers packets instead of the downstream device dropping them.
            Without PFC, RoCE performance degrades catastrophically because RDMA relies on the transport being lossless.</p>
        </div>

        <!-- 6.3 EGRESS QUEUING -->
        <h3 id="qos-queuing">6.3 Egress Queuing (ECN + Priority)</h3>

        <pre><span class="comment">! Egress queuing: scheduling + ECN for congestion signaling</span>
<span class="cmd">policy-map type queuing RDMA_ECN_OUT</span>
  class type queuing <span class="highlight">c-out-q3</span>
    priority level <span class="highlight">1</span>                              <span class="comment">&larr; strict priority (lowest latency)</span>
    random-detect threshold burst-optimized <span class="highlight">ecn</span>   <span class="comment">&larr; DCQCN congestion signaling</span>
  class type queuing c-out-q2
    bandwidth remaining percent 0
  class type queuing c-out-q1
    bandwidth remaining percent 0
  class type queuing <span class="highlight">c-out-q-default</span>
    bandwidth remaining percent <span class="highlight">100</span>               <span class="comment">&larr; all remaining BW for non-RDMA</span></pre>

        <h4>System QoS Application</h4>
        <pre><span class="comment">! Apply policies globally to the switching ASIC</span>
<span class="cmd">system qos</span>
  service-policy type network-qos <span class="highlight">QOS_NETWORK</span>      <span class="comment">&larr; PFC + MTU</span>
  service-policy type queuing output <span class="highlight">RDMA_ECN_OUT</span>  <span class="comment">&larr; ECN + scheduling</span></pre>

        <div class="card" style="border-color:#ce93d8;">
            <h4 style="margin-top:0; color:#ce93d8;">ECN + DCQCN Explained</h4>
            <p><strong>ECN (Explicit Congestion Notification)</strong> marks packets with a congestion bit instead of dropping them.
            When the ConnectX NIC receives an ECN-marked packet, it triggers <strong>DCQCN</strong> (Data Center QCN) &mdash;
            the NIC reduces its sending rate proactively, preventing queue buildup before PFC needs to pause.
            This gives us a two-layer defense:</p>
            <ul style="margin: 8px 0 0 20px;">
                <li><strong>Layer 1 &mdash; ECN/DCQCN</strong>: Proactive rate reduction (soft congestion signal)</li>
                <li><strong>Layer 2 &mdash; PFC</strong>: Last-resort pause frames (hard flow control, prevents drops)</li>
            </ul>
        </div>

        <!-- 6.4 DESIGN SUMMARY -->
        <h3 id="qos-summary">6.4 Design Summary</h3>

        <table>
            <tr><th>Layer</th><th>Policy / Feature</th><th>Purpose</th><th>Key Setting</th></tr>
            <tr>
                <td>Input Classification</td>
                <td><code>QOS_MARKING</code></td>
                <td>Identify RDMA traffic</td>
                <td>DSCP 26 + UDP 4741/4791 &rarr; qos-group 3</td>
            </tr>
            <tr>
                <td>Network QoS</td>
                <td><code>QOS_NETWORK</code></td>
                <td>Lossless transport</td>
                <td>PFC pause on CoS 3, MTU 9216</td>
            </tr>
            <tr>
                <td>Egress Queuing</td>
                <td><code>RDMA_ECN_OUT</code></td>
                <td>Priority + congestion</td>
                <td>Queue 3 = strict priority + ECN</td>
            </tr>
            <tr>
                <td>Interface</td>
                <td><code>PFC mode on</code></td>
                <td>Per-port flow control</td>
                <td>IEEE 802.1Qbb on all ports</td>
            </tr>
            <tr>
                <td>Protocol</td>
                <td><code>LLDP + DCBX</code></td>
                <td>Capability exchange</td>
                <td>Negotiate PFC parameters with NICs</td>
            </tr>
        </table>

        <div class="card" style="border-color:#ff9800;">
            <h4 style="margin-top:0; color:#ff9800;">QoS at a Glance</h4>
            <div style="display:flex; gap:20px; flex-wrap:wrap; margin-top:10px;">
                <div style="text-align:center; padding:12px 20px; background:rgba(79,195,247,0.1); border-radius:8px; border:1px solid #0288d1;">
                    <div style="font-size:1.6em; font-weight:bold; color:#4fc3f7;">DSCP 26</div>
                    <div style="font-size:0.85em; color:#81d4fa;">RDMA Classification</div>
                    <div style="font-size:0.75em; color:#616161;">+ RoCE UDP 4741/4791</div>
                </div>
                <div style="text-align:center; padding:12px 20px; background:rgba(239,83,80,0.1); border-radius:8px; border:1px solid #c62828;">
                    <div style="font-size:1.6em; font-weight:bold; color:#ef5350;">CoS 3</div>
                    <div style="font-size:0.85em; color:#ef9a9a;">PFC Lossless Queue</div>
                    <div style="font-size:0.75em; color:#616161;">IEEE 802.1Qbb Pause</div>
                </div>
                <div style="text-align:center; padding:12px 20px; background:rgba(206,147,216,0.1); border-radius:8px; border:1px solid #7b1fa2;">
                    <div style="font-size:1.6em; font-weight:bold; color:#ce93d8;">ECN</div>
                    <div style="font-size:0.85em; color:#e1bee7;">DCQCN Signaling</div>
                    <div style="font-size:0.75em; color:#616161;">Proactive rate control</div>
                </div>
                <div style="text-align:center; padding:12px 20px; background:rgba(102,187,106,0.1); border-radius:8px; border:1px solid #388e3c;">
                    <div style="font-size:1.6em; font-weight:bold; color:#66bb6a;">9216</div>
                    <div style="font-size:0.85em; color:#a5d6a7;">Jumbo MTU</div>
                    <div style="font-size:0.75em; color:#616161;">All queues</div>
                </div>
            </div>
        </div>

        <h4>Cleanup Scripts</h4>
        <table>
            <tr><th>Script</th><th>Purpose</th><th>Targets</th></tr>
            <tr>
                <td><code>check_leaf1_qos.py</code></td>
                <td>Audit QoS/DCB/PFC configuration on Leaf1</td>
                <td>Leaf1</td>
            </tr>
            <tr>
                <td><code>cleanup_leaf1_qos.py</code></td>
                <td>Remove unused class-maps &amp; policy-maps from Leaf1</td>
                <td>Leaf1</td>
            </tr>
            <tr>
                <td><code>check_all_qos.py</code></td>
                <td>Audit QoS configuration on all 4 switches</td>
                <td>All 4 switches</td>
            </tr>
            <tr>
                <td><code>cleanup_qos_all.py</code></td>
                <td>Clean Leaf2 junk + add ACL rdma to both spines</td>
                <td>Leaf2, Spine1, Spine2</td>
            </tr>
        </table>
    </div>

    <!-- ============================================================ -->
    <!-- 7. RDMA RAIL DESIGN -->
    <!-- ============================================================ -->
    <div class="section-panel" id="panel-rail-design">
        <h2 id="rail-design">7. RDMA Rail Design</h2>
        <div class="card">
            <p><strong>Concept:</strong> Each leaf switch acts as a dedicated "rail" for one port of each dual-port NIC.
            This ensures deterministic, low-latency paths for RDMA traffic. NCCL binds each GPU to a specific NIC,
            and Linux policy routing ensures traffic from that NIC always goes through the correct leaf.</p>

            <div class="grid-2">
                <div>
                    <h4 style="color:#66bb6a;">Rail 0 &mdash; Leaf1</h4>
                    <ul style="margin-left: 15px; font-size: 0.93em;">
                        <li>VLAN 100</li>
                        <li>Subnet: <code>10.0.0.0/24</code></li>
                        <li>SVI Gateway: <code>10.0.0.254</code></li>
                        <li>Server NIC: <code>ens6d1</code></li>
                        <li>Routing Table: <code>100 (rail0)</code></li>
                    </ul>
                </div>
                <div>
                    <h4 style="color:#42a5f5;">Rail 1 &mdash; Leaf2</h4>
                    <ul style="margin-left: 15px; font-size: 0.93em;">
                        <li>VLAN 101</li>
                        <li>Subnet: <code>10.0.1.0/24</code></li>
                        <li>SVI Gateway: <code>10.0.1.254</code></li>
                        <li>Server NIC: <code>ens6</code></li>
                        <li>Routing Table: <code>101 (rail1)</code></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Rail 0 -->
        <h3 id="rail0">7.1 Rail 0 &mdash; Leaf1 / VLAN 100</h3>
        <pre><span class="comment">! Leaf1 - Rail 0 Switch Configuration</span>

<span class="cmd">system jumbomtu</span> <span class="highlight">9216</span>

<span class="cmd">interface Eth1/27</span>
  <span class="cmd">switchport access vlan</span> <span class="highlight">100</span>
  <span class="cmd">mtu</span> 9216
  <span class="cmd">no shutdown</span>

<span class="cmd">interface Eth1/28</span>
  <span class="cmd">switchport access vlan</span> <span class="highlight">100</span>
  <span class="cmd">mtu</span> 9216
  <span class="cmd">no shutdown</span>

<span class="cmd">interface Vlan100</span>
  <span class="cmd">no shutdown</span>
  <span class="cmd">mtu</span> 9216
  <span class="cmd">ip address</span> <span class="ip">10.0.0.254/24</span></pre>

        <!-- Rail 1 -->
        <h3 id="rail1">7.2 Rail 1 &mdash; Leaf2 / VLAN 101</h3>
        <pre><span class="comment">! Leaf2 - Rail 1 Switch Configuration</span>

<span class="cmd">system jumbomtu</span> <span class="highlight">9216</span>

<span class="cmd">interface Eth1/27</span>
  <span class="cmd">switchport access vlan</span> <span class="highlight">101</span>
  <span class="cmd">mtu</span> 9216
  <span class="cmd">no shutdown</span>

<span class="cmd">interface Eth1/28</span>
  <span class="cmd">switchport access vlan</span> <span class="highlight">101</span>
  <span class="cmd">mtu</span> 9216
  <span class="cmd">no shutdown</span>

<span class="cmd">interface Vlan101</span>
  <span class="cmd">no shutdown</span>
  <span class="cmd">mtu</span> 9216
  <span class="cmd">ip address</span> <span class="ip">10.0.1.254/24</span></pre>
    </div>

    <!-- ============================================================ -->
    <!-- 8. SERVER CONFIGURATION -->
    <!-- ============================================================ -->
    <div class="section-panel" id="panel-server-config">
        <h2 id="server-config">8. GPU Server Configuration</h2>

        <h3 id="server-ips">8.1 NIC IP Addressing &amp; MTU</h3>
        <div class="card">
            <p>Each server has a dual-port Mellanox ConnectX-3 Pro NIC. Port 1 (<code>ens6d1</code>) connects to
            Leaf1 (Rail 0) and Port 2 (<code>ens6</code>) connects to Leaf2 (Rail 1). MTU is set to 9000 on both NICs.</p>
        </div>

        <div class="grid-2">
            <div class="card">
                <div class="card-header">
                    <span class="badge badge-server">gpuserver1</span>
                    <span style="color: var(--text-secondary);">192.168.51.73</span>
                </div>
                <pre style="margin:0"><span class="comment"># ens6d1 (Rail 0 - Leaf1)</span>
<span class="cmd">ip addr add</span> <span class="ip">10.0.0.1/24</span> dev ens6d1
<span class="cmd">ip link set</span> ens6d1 <span class="cmd">mtu</span> <span class="highlight">9000</span>
<span class="cmd">ip link set</span> ens6d1 <span class="cmd">up</span>

<span class="comment"># ens6 (Rail 1 - Leaf2)</span>
<span class="cmd">ip addr add</span> <span class="ip">10.0.1.1/24</span> dev ens6
<span class="cmd">ip link set</span> ens6 <span class="cmd">mtu</span> <span class="highlight">9000</span>
<span class="cmd">ip link set</span> ens6 <span class="cmd">up</span></pre>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="badge badge-server">gpuserver2</span>
                    <span style="color: var(--text-secondary);">192.168.51.71</span>
                </div>
                <pre style="margin:0"><span class="comment"># ens6d1 (Rail 0 - Leaf1)</span>
<span class="cmd">ip addr add</span> <span class="ip">10.0.0.2/24</span> dev ens6d1
<span class="cmd">ip link set</span> ens6d1 <span class="cmd">mtu</span> <span class="highlight">9000</span>
<span class="cmd">ip link set</span> ens6d1 <span class="cmd">up</span>

<span class="comment"># ens6 (Rail 1 - Leaf2)</span>
<span class="cmd">ip addr add</span> <span class="ip">10.0.1.2/24</span> dev ens6
<span class="cmd">ip link set</span> ens6 <span class="cmd">mtu</span> <span class="highlight">9000</span>
<span class="cmd">ip link set</span> ens6 <span class="cmd">up</span></pre>
            </div>
        </div>

        <h3 id="server-routing">8.2 Per-NIC Policy Routing</h3>
        <div class="card">
            <p><strong>How it works:</strong> Each NIC has its own Linux routing table. An <code>ip rule</code> matches
            the source IP of outgoing packets to select the correct table. This ensures traffic originating from
            ens6d1 always routes through Leaf1, and traffic from ens6 always routes through Leaf2.</p>
            <p style="margin-top:8px;"><strong>NCCL chain:</strong> NCCL binds GPU &rarr; NIC &rarr; NIC has source IP &rarr;
            <code>ip rule</code> matches source &rarr; correct routing table &rarr; correct leaf gateway.</p>
        </div>

        <pre><span class="comment"># Step 1: Register routing table names in /etc/iproute2/rt_tables</span>
<span class="cmd">echo</span> '<span class="highlight">100 rail0</span>' >> /etc/iproute2/rt_tables
<span class="cmd">echo</span> '<span class="highlight">101 rail1</span>' >> /etc/iproute2/rt_tables

<span class="comment"># Step 2: Rail 0 routing (ens6d1 → Leaf1 SVI 10.0.0.254)</span>
<span class="cmd">ip route add</span> <span class="ip">10.0.0.0/24</span> dev ens6d1 scope link <span class="cmd">table</span> <span class="highlight">100</span>
<span class="cmd">ip route add</span> default via <span class="ip">10.0.0.254</span> dev ens6d1 <span class="cmd">table</span> <span class="highlight">100</span>
<span class="cmd">ip rule add</span> from <span class="ip">&lt;ens6d1_ip&gt;</span> <span class="cmd">table</span> <span class="highlight">100</span>

<span class="comment"># Step 3: Rail 1 routing (ens6 → Leaf2 SVI 10.0.1.254)</span>
<span class="cmd">ip route add</span> <span class="ip">10.0.1.0/24</span> dev ens6 scope link <span class="cmd">table</span> <span class="highlight">101</span>
<span class="cmd">ip route add</span> default via <span class="ip">10.0.1.254</span> dev ens6 <span class="cmd">table</span> <span class="highlight">101</span>
<span class="cmd">ip rule add</span> from <span class="ip">&lt;ens6_ip&gt;</span> <span class="cmd">table</span> <span class="highlight">101</span></pre>

        <h4>Policy Routing per Server</h4>
        <table>
            <tr>
                <th>Server</th>
                <th>Rule: from</th>
                <th>Table</th>
                <th>Default Gateway</th>
                <th>Via Device</th>
                <th>Leaf</th>
            </tr>
            <tr>
                <td>gpuserver1</td><td><code>10.0.0.1</code></td><td>100 (rail0)</td>
                <td><code>10.0.0.254</code></td><td>ens6d1</td><td>Leaf1</td>
            </tr>
            <tr>
                <td>gpuserver1</td><td><code>10.0.1.1</code></td><td>101 (rail1)</td>
                <td><code>10.0.1.254</code></td><td>ens6</td><td>Leaf2</td>
            </tr>
            <tr>
                <td>gpuserver2</td><td><code>10.0.0.2</code></td><td>100 (rail0)</td>
                <td><code>10.0.0.254</code></td><td>ens6d1</td><td>Leaf1</td>
            </tr>
            <tr>
                <td>gpuserver2</td><td><code>10.0.1.2</code></td><td>101 (rail1)</td>
                <td><code>10.0.1.254</code></td><td>ens6</td><td>Leaf2</td>
            </tr>
        </table>

        <h3 id="server-netplan">8.3 Netplan Persistence</h3>
        <div class="card">
            <p>Configuration is persisted via <code>/etc/netplan/60-rdma-rails.yaml</code> on both servers (chmod 600).</p>
        </div>
        <pre><span class="comment"># /etc/netplan/60-rdma-rails.yaml (gpuserver1 example)</span>
<span class="cmd">network:</span>
  <span class="cmd">version:</span> 2
  <span class="cmd">ethernets:</span>
    <span class="cmd">ens6d1:</span>
      <span class="cmd">addresses:</span>
        - <span class="ip">10.0.0.1/24</span>
      <span class="cmd">mtu:</span> <span class="highlight">9000</span>
      <span class="cmd">routing-policy:</span>
        - <span class="cmd">from:</span> <span class="ip">10.0.0.1</span>
          <span class="cmd">table:</span> <span class="highlight">100</span>
      <span class="cmd">routes:</span>
        - <span class="cmd">to:</span> 0.0.0.0/0
          <span class="cmd">via:</span> <span class="ip">10.0.0.254</span>
          <span class="cmd">table:</span> <span class="highlight">100</span>
        - <span class="cmd">to:</span> <span class="ip">10.0.0.0/24</span>
          <span class="cmd">scope:</span> link
          <span class="cmd">table:</span> <span class="highlight">100</span>
    <span class="cmd">ens6:</span>
      <span class="cmd">addresses:</span>
        - <span class="ip">10.0.1.1/24</span>
      <span class="cmd">mtu:</span> <span class="highlight">9000</span>
      <span class="cmd">routing-policy:</span>
        - <span class="cmd">from:</span> <span class="ip">10.0.1.1</span>
          <span class="cmd">table:</span> <span class="highlight">101</span>
      <span class="cmd">routes:</span>
        - <span class="cmd">to:</span> 0.0.0.0/0
          <span class="cmd">via:</span> <span class="ip">10.0.1.254</span>
          <span class="cmd">table:</span> <span class="highlight">101</span>
        - <span class="cmd">to:</span> <span class="ip">10.0.1.0/24</span>
          <span class="cmd">scope:</span> link
          <span class="cmd">table:</span> <span class="highlight">101</span></pre>
    </div>

    <!-- ============================================================ -->
    <!-- 9. MTU -->
    <!-- ============================================================ -->
    <div class="section-panel" id="panel-mtu">
        <h2 id="mtu">9. MTU Configuration</h2>
        <table>
            <tr><th>Segment</th><th>MTU</th><th>Where</th></tr>
            <tr><td>Spine-Leaf fabric links</td><td><code>9216</code></td><td>Eth1/13, 1/14, 1/17, 1/18 on all switches</td></tr>
            <tr><td>Leaf SVIs (Vlan100, Vlan101)</td><td><code>9216</code></td><td>Leaf1 Vlan100, Leaf2 Vlan101</td></tr>
            <tr><td>Leaf server-facing ports</td><td><code>9216</code></td><td>Eth1/27, Eth1/28 on both leaves</td></tr>
            <tr><td>System jumbomtu (L2)</td><td><code>9216</code></td><td>Both leaves (<code>system jumbomtu 9216</code>)</td></tr>
            <tr><td>Server NICs</td><td><code>9000</code></td><td>ens6d1, ens6 on both GPU servers</td></tr>
        </table>
    </div>

    <!-- ============================================================ -->
    <!-- 10. CHANGE LOG -->
    <!-- ============================================================ -->
    <div class="section-panel" id="panel-changes">
        <h2 id="changes">10. Change Log &amp; Issues Resolved</h2>

        <div class="timeline">
            <div class="timeline-item">
                <div class="step-title">Step 1: Gathered Current State</div>
                <p>Ran <code>gather_leaf_state.py</code> to collect VLANs, port status, IPs, BGP/OSPF configs, and CDP neighbors from all 4 switches. Found both leaves had Eth1/27 (VLAN 100) and Eth1/28 (VLAN 101) as access ports, but no SVIs. BGP was L2VPN EVPN only with iBGP AS 65101 + OSPF underlay.</p>
            </div>

            <div class="timeline-item">
                <div class="step-title">Step 2: Configured RDMA Rail VLANs &amp; SVIs</div>
                <p>Ran <code>configure_rdma_rails.py</code>. Configured Leaf1 with VLAN 100 SVI (10.0.0.254/24) and Leaf2 with VLAN 101 SVI (10.0.1.254/24). Set jumbo MTU on all fabric and server-facing links. Added BGP IPv4 unicast network statements.</p>
            </div>

            <div class="timeline-item fix">
                <div class="step-title">Issue: Vlan1 IP Conflict</div>
                <p>Leaf1 had <code>Vlan1 IP 10.0.0.3/24</code> and Leaf2 had <code>Vlan1 IP 10.0.0.4/24</code> which overlapped with the Rail 0 subnet (10.0.0.0/24). On Leaf2, the directly connected Vlan1 route (AD 0) beat the BGP route (AD 200) to 10.0.0.0/24.</p>
                <p><strong>Fix:</strong> Ran <code>fix_vlan1_conflict.py</code> &mdash; removed IP from Vlan1 and shut it down on both leaves.</p>
            </div>

            <div class="timeline-item fix">
                <div class="step-title">Issue: Leaf1 SVI Missing IP</div>
                <p>When <code>configure_rdma_rails.py</code> initially ran, NX-OS silently rejected the Vlan100 IP (10.0.0.254/24) because Vlan1 already had 10.0.0.3/24 in the same subnet. After removing Vlan1's IP, the SVI was still empty.</p>
                <p><strong>Fix:</strong> Ran <code>fix_leaf1_svi.py</code> &mdash; re-applied <code>ip address 10.0.0.254/24</code> to Vlan100.</p>
            </div>

            <div class="timeline-item">
                <div class="step-title">Step 3: Migrated to eBGP Underlay</div>
                <p>Ran <code>migrate_ospf_to_bgp.py</code>. Removed old iBGP (AS 65101) and OSPF from all 4 switches. Created new eBGP configuration with AS 65000 (spines), 65001 (Leaf1), 65002 (Leaf2). Physical interface peering with BFD. ECMP via <code>maximum-paths 2</code> on leaves.</p>
            </div>

            <div class="timeline-item">
                <div class="step-title">Step 4: Configured GPU Server Policy Routing</div>
                <p>Ran <code>configure_gpu_servers.py</code>. Configured both servers with per-NIC IPs, MTU 9000, policy routing tables (100/101), and persistent netplan configuration. All cross-server reachability tests passed (same-rail and cross-rail).</p>
            </div>

            <div class="timeline-item">
                <div class="step-title">Step 5: Updated Topology Diagram</div>
                <p>Updated <code>AI_Cluster_Topology.drawio</code> with eBGP AS numbers, correct per-leaf VLANs, SVI IPs, server routing table info, and revised fabric summary.</p>
            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- 11. SCRIPTS -->
    <!-- ============================================================ -->
    <div class="section-panel" id="panel-scripts">
        <h2 id="scripts">11. Automation Scripts</h2>
        <div class="card">
            <p>All scripts are located in <code>C:\Claude\AI_LAB\scripts\</code> and use <strong>Netmiko</strong> for SSH automation.</p>
        </div>
        <table>
            <tr><th>Script</th><th>Purpose</th><th>Targets</th></tr>
            <tr>
                <td><code>gather_leaf_state.py</code></td>
                <td>Collect current VLANs, ports, IPs, BGP/OSPF configs from all switches</td>
                <td>All 4 switches</td>
            </tr>
            <tr>
                <td><code>configure_rdma_rails.py</code></td>
                <td>Configure VLAN+SVI, access ports, MTU, BGP IPv4 unicast</td>
                <td>All 4 switches</td>
            </tr>
            <tr>
                <td><code>fix_vlan1_conflict.py</code></td>
                <td>Remove conflicting Vlan1 IPs overlapping with RDMA subnets</td>
                <td>Leaf1, Leaf2</td>
            </tr>
            <tr>
                <td><code>fix_leaf1_svi.py</code></td>
                <td>Re-apply missing IP address to Leaf1 Vlan100 SVI</td>
                <td>Leaf1</td>
            </tr>
            <tr>
                <td><code>diagnose_svi.py</code></td>
                <td>Diagnostic: check SVI state, running-config, IP interface status</td>
                <td>Leaf1, Leaf2</td>
            </tr>
            <tr>
                <td><code>verify_rdma_routing.py</code></td>
                <td>Verify BGP tables, summaries, and routes on all switches</td>
                <td>All 4 switches</td>
            </tr>
            <tr>
                <td><code>migrate_ospf_to_bgp.py</code></td>
                <td>Migrate from iBGP+OSPF to eBGP with physical interface peering</td>
                <td>All 4 switches</td>
            </tr>
            <tr>
                <td><code>configure_gpu_servers.py</code></td>
                <td>Configure per-NIC IPs, MTU, policy routing, netplan on GPU servers</td>
                <td>gpuserver1, gpuserver2</td>
            </tr>
        </table>
    </div>

    <!-- ============================================================ -->
    <!-- 12. VERIFICATION -->
    <!-- ============================================================ -->
    <div class="section-panel" id="panel-verification">
        <h2 id="verification">12. Verification Results</h2>

        <h3>eBGP Sessions &mdash; All Established</h3>
        <table>
            <tr><th>Device</th><th>Neighbor</th><th>Remote AS</th><th>State</th></tr>
            <tr><td>Spine1</td><td><code>10.4.0.5</code> (Leaf1)</td><td>65001</td><td class="status-ok">Established</td></tr>
            <tr><td>Spine1</td><td><code>10.4.0.14</code> (Leaf2)</td><td>65002</td><td class="status-ok">Established</td></tr>
            <tr><td>Spine2</td><td><code>10.4.0.1</code> (Leaf1)</td><td>65001</td><td class="status-ok">Established</td></tr>
            <tr><td>Spine2</td><td><code>10.4.0.9</code> (Leaf2)</td><td>65002</td><td class="status-ok">Established</td></tr>
            <tr><td>Leaf1</td><td><code>10.4.0.6</code> (Spine1)</td><td>65000</td><td class="status-ok">Established</td></tr>
            <tr><td>Leaf1</td><td><code>10.4.0.2</code> (Spine2)</td><td>65000</td><td class="status-ok">Established</td></tr>
            <tr><td>Leaf2</td><td><code>10.4.0.13</code> (Spine1)</td><td>65000</td><td class="status-ok">Established</td></tr>
            <tr><td>Leaf2</td><td><code>10.4.0.10</code> (Spine2)</td><td>65000</td><td class="status-ok">Established</td></tr>
        </table>

        <h3>Cross-Rail Routing &mdash; ECMP Working</h3>
        <div class="card">
            <p>Leaves have 2 equal-cost paths to remote rail subnets via both spines:</p>
            <pre style="margin:8px 0 0 0;"><span class="comment">! Leaf1: route to Rail 1 subnet (10.0.1.0/24) - 2 paths</span>
<span class="ip">10.0.1.0/24</span>, ubest/mbest: <span class="highlight">2/0</span>
    *via <span class="ip">10.4.0.6</span>, [20/0], BGP-65000   <span class="comment">&larr; via Spine1</span>
    *via <span class="ip">10.4.0.2</span>, [20/0], BGP-65000   <span class="comment">&larr; via Spine2</span>

<span class="comment">! Leaf2: route to Rail 0 subnet (10.0.0.0/24) - 2 paths</span>
<span class="ip">10.0.0.0/24</span>, ubest/mbest: <span class="highlight">2/0</span>
    *via <span class="ip">10.4.0.13</span>, [20/0], BGP-65000  <span class="comment">&larr; via Spine1</span>
    *via <span class="ip">10.4.0.10</span>, [20/0], BGP-65000  <span class="comment">&larr; via Spine2</span></pre>
        </div>

        <h3>Cross-Server Reachability &mdash; All Passed</h3>
        <table>
            <tr><th>Test</th><th>From</th><th>To</th><th>Path</th><th>Result</th></tr>
            <tr>
                <td>Same-rail (Rail 0)</td>
                <td>gpu1 10.0.0.1</td><td>gpu2 10.0.0.2</td>
                <td>via Leaf1 only</td>
                <td class="status-ok">PASS</td>
            </tr>
            <tr>
                <td>Same-rail (Rail 1)</td>
                <td>gpu1 10.0.1.1</td><td>gpu2 10.0.1.2</td>
                <td>via Leaf2 only</td>
                <td class="status-ok">PASS</td>
            </tr>
            <tr>
                <td>Cross-rail</td>
                <td>gpu1 Rail 0 (10.0.0.1)</td><td>gpu2 Rail 1 (10.0.1.2)</td>
                <td>Leaf1 &rarr; Spine &rarr; Leaf2</td>
                <td class="status-ok">PASS</td>
            </tr>
            <tr>
                <td>Cross-rail</td>
                <td>gpu1 Rail 1 (10.0.1.1)</td><td>gpu2 Rail 0 (10.0.0.2)</td>
                <td>Leaf2 &rarr; Spine &rarr; Leaf1</td>
                <td class="status-ok">PASS</td>
            </tr>
        </table>
    </div>

    <!-- ============================================================ -->
    <!-- 13. RDMA PERFORMANCE RESULTS -->
    <!-- ============================================================ -->
    <div class="section-panel" id="panel-rdma-perf">
        <h2 id="rdma-perf">13. RDMA Performance Results</h2>
        <div class="card">
            <p>Tested with <code>ib_write_bw</code> and <code>ib_write_lat</code> (perftest suite) using RDMA Write operations
            over RoCE (RDMA over Converged Ethernet). All tests run between gpuserver1 and gpuserver2.</p>
            <table style="margin-top:10px;">
                <tr><th>Parameter</th><th>Value</th></tr>
                <tr><td>RDMA Device</td><td><code>rocep130s0</code> (Mellanox ConnectX-3 Pro)</td></tr>
                <tr><td>Link Speed</td><td>40 GbE per port</td></tr>
                <tr><td>IB MTU</td><td>4096 bytes (<code>-m 4096</code>)</td></tr>
                <tr><td>Ethernet MTU</td><td>9000 (servers) / 9216 (switches)</td></tr>
                <tr><td>Mode</td><td>RoCE (<code>-F</code> flag), all message sizes (<code>-a</code>)</td></tr>
                <tr><td>Connection</td><td>RC (Reliable Connection)</td></tr>
            </table>
        </div>

        <!-- 13.1 BANDWIDTH -->
        <h3 id="rdma-bw">13.1 Bandwidth Tests (ib_write_bw)</h3>

        <h4>Results &mdash; IB MTU 4096</h4>
        <table>
            <tr>
                <th>Test</th>
                <th>Path</th>
                <th>Peak BW</th>
                <th>Avg @ 8MB</th>
                <th>% Wire Rate</th>
            </tr>
            <tr>
                <td><span class="badge badge-rail0">Same Rail 0</span></td>
                <td>gpu1 <code>10.0.0.1</code> &harr; gpu2 <code>10.0.0.2</code> via Leaf1</td>
                <td style="color:#66bb6a; font-weight:bold;">38.98 Gb/s</td>
                <td>30.70 Gb/s</td>
                <td>~97%</td>
            </tr>
            <tr>
                <td><span class="badge badge-rail1">Same Rail 1</span></td>
                <td>gpu1 <code>10.0.1.1</code> &harr; gpu2 <code>10.0.1.2</code> via Leaf2</td>
                <td style="color:#42a5f5; font-weight:bold;">38.95 Gb/s</td>
                <td>30.48 Gb/s</td>
                <td>~97%</td>
            </tr>
            <tr>
                <td style="background:rgba(255,152,0,0.1);"><span style="color:#ff9800; font-weight:bold;">Cross-Rail</span></td>
                <td>gpu1 Rail0 <code>10.0.0.1</code> &rarr; gpu2 Rail1 <code>10.0.1.2</code> via Spine</td>
                <td style="color:#ff9800; font-weight:bold;">38.94 Gb/s</td>
                <td style="font-weight:bold;">37.36 Gb/s</td>
                <td>~97%</td>
            </tr>
        </table>

        <h4>MTU Comparison &mdash; 2048 vs 4096</h4>
        <table>
            <tr>
                <th>Test</th>
                <th>Peak (MTU 2048)</th>
                <th>Peak (MTU 4096)</th>
                <th>Improvement</th>
                <th>Cross-Rail Avg@8MB (2048)</th>
                <th>Cross-Rail Avg@8MB (4096)</th>
            </tr>
            <tr>
                <td>Same Rail 0</td>
                <td>38.01 Gb/s</td>
                <td style="color:#66bb6a; font-weight:bold;">38.98 Gb/s</td>
                <td>+2.5%</td>
                <td colspan="2" style="color:#616161;">&mdash;</td>
            </tr>
            <tr>
                <td>Same Rail 1</td>
                <td>38.44 Gb/s</td>
                <td style="color:#42a5f5; font-weight:bold;">38.95 Gb/s</td>
                <td>+1.3%</td>
                <td colspan="2" style="color:#616161;">&mdash;</td>
            </tr>
            <tr>
                <td>Cross-Rail</td>
                <td>38.07 Gb/s</td>
                <td style="color:#ff9800; font-weight:bold;">38.94 Gb/s</td>
                <td>+2.3%</td>
                <td>33.17 Gb/s</td>
                <td style="color:#66bb6a; font-weight:bold;">37.36 Gb/s (+12.6%)</td>
            </tr>
        </table>

        <!-- 13.2 LATENCY -->
        <h3 id="rdma-lat">13.2 Latency Tests (ib_write_lat)</h3>

        <h4>Results &mdash; IB MTU 4096</h4>
        <table>
            <tr>
                <th>Test</th>
                <th>2 bytes</th>
                <th>1 KB</th>
                <th>64 KB</th>
                <th>8 MB</th>
            </tr>
            <tr>
                <td><span class="badge badge-rail0">Same Rail 0</span></td>
                <td style="color:#66bb6a; font-weight:bold;">2.92 &mu;s</td>
                <td>4.56 &mu;s</td>
                <td>18.70 &mu;s</td>
                <td>2,137 &mu;s</td>
            </tr>
            <tr>
                <td><span class="badge badge-rail1">Same Rail 1</span></td>
                <td style="color:#42a5f5; font-weight:bold;">3.05 &mu;s</td>
                <td>4.55 &mu;s</td>
                <td>18.67 &mu;s</td>
                <td>2,119 &mu;s</td>
            </tr>
            <tr>
                <td style="background:rgba(255,152,0,0.1);"><span style="color:#ff9800; font-weight:bold;">Cross-Rail</span></td>
                <td style="color:#ff9800; font-weight:bold;">5.37 &mu;s</td>
                <td>7.99 &mu;s</td>
                <td>24.45 &mu;s</td>
                <td>2,125 &mu;s</td>
            </tr>
        </table>

        <div class="card">
            <h4 style="margin-top:0;">Latency Analysis</h4>
            <ul style="margin: 8px 0 0 20px;">
                <li><strong>Same-rail small message latency: ~3 &mu;s</strong> &mdash; packet traverses Server NIC &rarr; Leaf switch &rarr; Server NIC (1 switch hop)</li>
                <li><strong>Cross-rail adds ~2.4 &mu;s</strong> &mdash; packet traverses Leaf &rarr; Spine &rarr; Leaf (3 switch hops instead of 1)</li>
                <li><strong>At large sizes (8 MB)</strong>, all paths converge to ~2.1 ms &mdash; serialization time dominates over switching latency</li>
                <li><strong>Both rails symmetric</strong> &mdash; Leaf1 (Rail 0) and Leaf2 (Rail 1) perform identically</li>
            </ul>
        </div>

        <!-- 13.3 CONTEXT -->
        <h3 id="rdma-context">13.3 How Our Lab Compares</h3>
        <div class="card">
            <p>RDMA bypasses the kernel and TCP/IP stack entirely &mdash; data moves directly from NIC memory to NIC memory
            (zero-copy). This is why RDMA latency is orders of magnitude lower than regular TCP networking.</p>
        </div>

        <table>
            <tr><th>Technology</th><th>Typical Latency</th><th>Notes</th></tr>
            <tr style="background:rgba(102,187,106,0.1);">
                <td style="font-weight:bold; color:#66bb6a;">Our Same-Rail RDMA (40GbE RoCE)</td>
                <td style="font-weight:bold; color:#66bb6a;">~3 &mu;s</td>
                <td>1 switch hop (server &rarr; leaf &rarr; server)</td>
            </tr>
            <tr style="background:rgba(255,152,0,0.1);">
                <td style="font-weight:bold; color:#ff9800;">Our Cross-Rail RDMA (via Spine)</td>
                <td style="font-weight:bold; color:#ff9800;">~5.4 &mu;s</td>
                <td>3 switch hops (leaf &rarr; spine &rarr; leaf)</td>
            </tr>
            <tr>
                <td>Typical TCP ping (same network)</td>
                <td>~100&ndash;300 &mu;s</td>
                <td>Kernel stack, context switches, TCP overhead</td>
            </tr>
            <tr>
                <td>Regular Ethernet (no RDMA)</td>
                <td>~50&ndash;100 &mu;s</td>
                <td>Still goes through kernel networking stack</td>
            </tr>
            <tr>
                <td>NVIDIA NVLink (GPU-to-GPU)</td>
                <td>~1&ndash;2 &mu;s</td>
                <td>Direct GPU interconnect within same server</td>
            </tr>
            <tr>
                <td>PCIe (within same server)</td>
                <td>~0.5&ndash;1 &mu;s</td>
                <td>CPU-to-device within single machine</td>
            </tr>
        </table>

        <div class="card" style="border-color:#ff9800;">
            <h4 style="margin-top:0; color:#ff9800;">Bandwidth Summary</h4>
            <div style="display:flex; gap:30px; flex-wrap:wrap; margin-top:10px;">
                <div style="text-align:center; padding:12px 20px; background:rgba(102,187,106,0.1); border-radius:8px; border:1px solid #388e3c;">
                    <div style="font-size:2em; font-weight:bold; color:#66bb6a;">~39 Gb/s</div>
                    <div style="font-size:0.85em; color:#a5d6a7;">Peak Bandwidth</div>
                    <div style="font-size:0.75em; color:#616161;">97% of 40GbE wire rate</div>
                </div>
                <div style="text-align:center; padding:12px 20px; background:rgba(66,165,245,0.1); border-radius:8px; border:1px solid #1976d2;">
                    <div style="font-size:2em; font-weight:bold; color:#42a5f5;">~3 &mu;s</div>
                    <div style="font-size:0.85em; color:#90caf9;">Same-Rail Latency</div>
                    <div style="font-size:0.75em; color:#616161;">Small messages (2 bytes)</div>
                </div>
                <div style="text-align:center; padding:12px 20px; background:rgba(255,152,0,0.1); border-radius:8px; border:1px solid #f57c00;">
                    <div style="font-size:2em; font-weight:bold; color:#ff9800;">+2.4 &mu;s</div>
                    <div style="font-size:0.85em; color:#ffcc80;">Cross-Rail Overhead</div>
                    <div style="font-size:0.75em; color:#616161;">Extra spine hop penalty</div>
                </div>
            </div>
        </div>

        <h4>Test Commands Reference</h4>
        <pre><span class="comment"># Bandwidth test -- Server side (gpuserver2):</span>
<span class="cmd">ib_write_bw</span> -d rocep130s0 -i &lt;ib_port&gt; --source_ip &lt;server_ip&gt; --port=&lt;tcp_port&gt; -m 4096 -F --report_gbits -a

<span class="comment"># Bandwidth test -- Client side (gpuserver1):</span>
<span class="cmd">ib_write_bw</span> -d rocep130s0 -i &lt;ib_port&gt; --source_ip &lt;client_ip&gt; --port=&lt;tcp_port&gt; -m 4096 -F --report_gbits -a &lt;server_ip&gt;

<span class="comment"># Latency test -- same flags, replace ib_write_bw with ib_write_lat (no --report_gbits)</span>
<span class="cmd">ib_write_lat</span> -d rocep130s0 -i &lt;ib_port&gt; --source_ip &lt;ip&gt; --port=&lt;tcp_port&gt; -m 4096 -F -a [server_ip]

<span class="comment"># IB Port mapping:</span>
<span class="comment">#   -i 1 = ens6   (Rail 1, 10.0.1.x via Leaf2)</span>
<span class="comment">#   -i 2 = ens6d1 (Rail 0, 10.0.0.x via Leaf1)</span>
<span class="comment"># IMPORTANT: Use -i for IB port, NOT -p (which sets TCP port)</span>
<span class="comment"># Use -m 4096 for jumbo IB MTU (default is only 2048)</span>
<span class="comment"># Use unique --port values (19001, 19002...) to avoid TCP conflicts</span></pre>

        <hr>

        <div class="footer">
            GPU AI Cluster Lab Documentation &mdash; Updated February 2026<br>
            Project Directory: <code>C:\Claude\AI_LAB\</code><br>
            Topology Diagram: <code>C:\Claude\AI_LAB\diagrams\AI_Cluster_Topology.drawio</code>
        </div>
    </div>

</main>

<!-- ── JavaScript ── -->
<script>
    // Section IDs in order
    const sections = [
        'overview', 'topology', 'inventory', 'fabric-links', 'ebgp',
        'qos-config', 'rail-design', 'server-config', 'mtu', 'changes',
        'scripts', 'verification', 'rdma-perf'
    ];

    function showSection(sectionId, scrollToId) {
        // Hide all panels
        document.querySelectorAll('.section-panel').forEach(function(panel) {
            panel.classList.remove('active');
        });

        // Show selected panel
        var panel = document.getElementById('panel-' + sectionId);
        if (panel) {
            panel.classList.add('active');
        }

        // Update active nav link
        document.querySelectorAll('.sidebar-nav a[data-section]').forEach(function(link) {
            link.classList.remove('active');
        });
        // Activate all nav links pointing to this section
        document.querySelectorAll('.sidebar-nav a[data-section="' + sectionId + '"]').forEach(function(link) {
            if (!scrollToId && !link.getAttribute('data-scroll')) {
                link.classList.add('active');
            } else if (scrollToId && link.getAttribute('data-scroll') === scrollToId) {
                link.classList.add('active');
            } else if (!scrollToId && !link.classList.contains('indent')) {
                link.classList.add('active');
            }
        });

        // Collapse all sub-items, expand only the active section's
        document.querySelectorAll('.sidebar-nav .sub-items').forEach(function(sub) {
            sub.classList.remove('expanded');
        });
        var activeSub = document.querySelector('.sidebar-nav .sub-items[data-parent="' + sectionId + '"]');
        if (activeSub) {
            activeSub.classList.add('expanded');
        }

        // Update URL hash
        var hashId = scrollToId || sectionId;
        if (history.replaceState) {
            history.replaceState(null, null, '#' + hashId);
        }

        // Scroll content area to top, then to sub-section if needed
        var contentArea = document.getElementById('content-area');
        contentArea.scrollTop = 0;

        if (scrollToId) {
            setTimeout(function() {
                var target = document.getElementById(scrollToId);
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 50);
        }

        // Close sidebar on mobile
        if (window.innerWidth <= 900) {
            document.getElementById('sidebar').classList.remove('open');
        }
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
    }

    // Map sub-section IDs to their parent section
    var subSectionMap = {
        'ebgp-spine1': 'ebgp',
        'ebgp-spine2': 'ebgp',
        'ebgp-leaf1': 'ebgp',
        'ebgp-leaf2': 'ebgp',
        'qos-classification': 'qos-config',
        'qos-network': 'qos-config',
        'qos-queuing': 'qos-config',
        'qos-summary': 'qos-config',
        'rail0': 'rail-design',
        'rail1': 'rail-design',
        'server-ips': 'server-config',
        'server-routing': 'server-config',
        'server-netplan': 'server-config',
        'rdma-bw': 'rdma-perf',
        'rdma-lat': 'rdma-perf',
        'rdma-context': 'rdma-perf'
    };

    // Handle hash on load and hashchange
    function handleHash() {
        var hash = window.location.hash.replace('#', '');
        if (!hash) {
            showSection('overview');
            return;
        }

        // Check if it's a main section
        if (sections.indexOf(hash) !== -1) {
            showSection(hash);
        }
        // Check if it's a sub-section
        else if (subSectionMap[hash]) {
            showSection(subSectionMap[hash], hash);
        }
        else {
            showSection('overview');
        }
    }

    // Wire up sub-item clicks with data-scroll
    document.querySelectorAll('.sidebar-nav a[data-scroll]').forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            var section = this.getAttribute('data-section');
            var scrollTo = this.getAttribute('data-scroll');
            showSection(section, scrollTo);
        });
    });

    // Handle hash changes
    window.addEventListener('hashchange', handleHash);

    // Initialize on load
    window.addEventListener('DOMContentLoaded', handleHash);

    // Close sidebar when clicking outside on mobile
    document.getElementById('content-area').addEventListener('click', function() {
        if (window.innerWidth <= 900) {
            document.getElementById('sidebar').classList.remove('open');
        }
    });
</script>

</body>
</html>
